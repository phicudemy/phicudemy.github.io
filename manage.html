---
title: مدیریت کاربران
slug: manage
layout: default
permalink: /manage/
---
<div class="container">
  <div class="row">
    <div class="col">
      <div id="admin-dashboard">
        <h2>{{page.title}}</h2>
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th scope="col">نام</th>
              <th scope="col">همراه</th>
              <th scope="col">ایمیل</th>
              <th scope="col">نقش</th>
            </tr>
          </thead>
          <tbody id="user-list">

          </tbody>
        </table>
      </div>
      
    </div>
  </div>
</div>

<script>

// Check if user is admin
async function checkAdminAccess() {
  const { data: { user }, error } = await client.auth.getUser();
  if (error || !user || user.user_metadata.role !== "admin") {
    alert("دسترسی غیرمجاز");
    window.location.href = "/";
    return;
  }
}

async function loadAdminDashboard() {
  const { data: { session }, error: sessionError } = await client.auth.getSession();

  if (sessionError || !session || !session.access_token) {
    document.getElementById("user-list").innerHTML = `<div class="text-danger">لطفاً وارد شوید.</div>`;
    return;
  }

  const token = session.access_token;

  const response = await fetch(`${SUPABASE_URL}/functions/v1/list_users`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    }
  });

  const result = await response.json();

  const userList = document.getElementById("user-list");
  userList.innerHTML = "";

  if (!Array.isArray(result.users)) {
    userList.innerHTML = `<div class="text-danger">خطا در بارگذاری کاربران</div>`;
    return;
  }

  result.users.forEach(user => {
  const div = document.createElement("tr");

  const role = user.role || "user";
  const fullName = user.full_name || "-";
  const phone = user.phone || "-";

  div.innerHTML = `
      <th scope="row"><strong>${fullName}</strong></th>
      <td>${phone}</td>
      <td>${user.email}</td>
      <td>
        <select onchange="updateUserRole('${user.id}', this.value)">
          <option value="user" ${role === "user" ? "selected" : ""}>کاربر</option>
          <option value="admin" ${role === "admin" ? "selected" : ""}>ادمین</option>
        </select>
      </td>
      `;

    userList.appendChild(div);
  });
}

async function updateUserRole(userId, newRole) {
  const { data: { session }, error } = await client.auth.getSession();
  if (!session || !session.access_token) return alert("شما وارد نشده‌اید.");

  const token = session.access_token;

  const response = await fetch(`${SUPABASE_URL}/functions/v1/update_user_role`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ user_id: userId, new_role: newRole })
  });

  const result = await response.json();

  if (result.error) {
    alert("خطا در بروزرسانی نقش: " + result.error);
  } else {
    alert("نقش با موفقیت بروزرسانی شد.");
    loadAdminDashboard();
  }
}

// Initialize
window.onload = async () => {
  await checkAdminAccess();
  await loadAdminDashboard();
};

</script>
